<!DOCTYPE html>
<html lang="ro" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Fabrica de Coduri ‚Äì Dashboard</title>
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
    <style>
        /* Mic styling local pentru Cuprins (capitole + lec»õii) din modal */
        .toc { max-height: 380px; overflow: auto; border: 1px solid var(--border); border-radius: 10px; padding: 8px; background: var(--bgElevated, #fff); }
        .toc .ch { margin-bottom: 10px; }
        .toc .ch-title { display:flex; align-items:center; gap:8px; font-weight:600; }
        .toc .ch-desc { margin:4px 0 0 24px; color: var(--muted); font-size: 0.92em; }
        .toc .ls { margin: 6px 0 0 24px; }
        .toc .ls div { padding: 4px 0; border-radius: 6px; }
        .toc .ls div:hover { background: rgba(0,0,0,.04); }
        .modal-img { width:100%; max-height:260px; object-fit:cover; border-radius:10px; margin-top:8px; border:1px solid var(--border) }

        /* Op»õional: stil pentru butonul "Scoate din co»ô" */
        .btn.danger { background:#ef4444; color:#fff; }
        .btn.danger:hover { filter:brightness(.95) }
    </style>
</head>
<body>

<div class="topbar" role="banner">
    <button id="menuBtn" class="hamburger" aria-label="Deschide meniul" aria-controls="sidebar" aria-expanded="false">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M4 7h16M4 12h16M4 17h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>
    </button>
</div>

<div class="app">
    <div th:replace="~{fragments/left-menu :: left-menu}"></div>

    <main>
        <header class="toolbar">
            <div class="searchbar" role="search">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M21 21l-4.2-4.2" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2" />
                </svg>
                <input id="q" type="search" placeholder="CautƒÉ cursuri, limbaje, topicuri‚Ä¶ (ex: Spring, Python OOP)" />
            </div>

            <!-- Valorile sunt etichete umane; mapƒÉm √Æn JS la enum -->
            <select id="stack-select" aria-label="Filtru stack">
                <option value="">Toate stack-urile</option>
                <option value="Frontend">Frontend</option>
                <option value="Backend">Backend</option>
                <option value="AI">AI</option>
                <option value="Gaming">Gaming</option>
                <option value="Mobile">Mobile</option>
                <option value="DevOps">DevOps</option>
            </select>

            <select id="lang-select" aria-label="Filtru limbaj">
                <option value="">Toate limbajele</option>
                <option>Java</option>
                <option>Python</option>
                <option>JavaScript</option>
                <option>TypeScript</option>
                <option>PHP</option>
                <option>C#</option>
                <option>C++</option>
                <option>Go</option>
                <option>Rust</option>
                <option>Swift</option>
                <option>Kotlin</option>
            </select>

            <button class="btn" id="reset-btn" title="ReseteazƒÉ filtrele">Reset</button>
            <button class="btn primary" id="apply-btn">AplicƒÉ</button>
        </header>

        <div class="content">
            <div>
                <!-- chips rapide (ex. Frontend / Java) -->
                <section class="chips" id="quick-chips"></section>
                <!-- filtre active -->
                <section class="chips" id="active-filters"></section>

                <section id="results" class="grid" aria-live="polite"></section>
                <nav id="pager" class="pager" aria-label="Paginare"></nav>
            </div>

            <aside class="right-rail" aria-label="RecomandƒÉri »ôi promo»õii">
                <div class="rr-card" id="rr-promo">
                    <h4>üéâ Promo septembrie</h4>
                    <p style="margin:6px 0 10px">-25% la pachetele <strong>Backend</strong> & <strong>AI</strong> p√¢nƒÉ la <strong>30 sept</strong>.</p>
                    <div class="rr-cta">
                        <a class="btn primary" href="/oferta">Prinde oferta</a>
                        <a class="btn" href="/pachete">Vezi pachete</a>
                    </div>
                    <p class="m" style="margin-top:8px;color:var(--muted);font-size:12px">Garan»õie 14 zile money-back.</p>
                </div>

                <div class="rr-card">
                    <h4>‚≠ê NoutƒÉ»õi</h4>
                    <div class="rr-list" id="rr-top"></div>
                </div>

                <div class="rr-card">
                    <h4>üïí VƒÉzute recent</h4>
                    <div class="rr-list" id="rr-recent"></div>
                </div>
            </aside>
        </div>
    </main>
</div>

<!-- Overlay (reutilizat pentru modal & drawer) -->
<div class="overlay" id="overlay" hidden></div>

<!-- Modal curs (rezumat pentru listƒÉ) -->
<div id="courseModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="courseTitle" aria-describedby="courseDesc" hidden>
    <div class="modal-panel">
        <header class="modal-head">
            <div>
                <h2 id="courseTitle" class="modal-title"></h2>
                <p class="modal-sub" id="courseSub"></p>
            </div>
            <button id="modalClose" class="icon-btn" aria-label="√énchide detaliile cursului">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                </svg>
            </button>
        </header>
        <div class="modal-body">
            <div class="detail-split">
                <img id="detailCover" class="detail-cover" src="" alt="">
                <section class="detail-toc-pane">
                    <div id="courseToc" class="toc"></div>
                </section>
            </div>
            <div style="margin-top:14px">
                <strong>Descriere</strong>
                <p id="courseDesc" style="margin-top:6px"></p>
            </div>
            <div id="courseBadges" class="chips" style="margin-top:10px"></div>
        </div>
        <footer class="modal-foot">
            <button id="addToCart" class="btn">AdaugƒÉ √Æn co»ô</button>
            <button id="buy" class="btn">CumpƒÉrƒÉ</button>
        </footer>
    </div>
</div>

<script>
    /**
     * ===== CONFIG =====
     */
    const REMOTE_JSON_URL = '/dashboard/courses/data';
    const DEFAULT_PAGE_SIZE = 9;

    // Co»ô
    const CART_URL = '/api/cart';            // GET: sumar co»ô
    const CART_ADD_URL = '/api/cart/items';  // POST: { courseId }
    const CHECKOUT_URL = '/checkout';        // redirect dupƒÉ "CumpƒÉrƒÉ"

    /**
     * MapƒÉri UI <-> Enum
     */
    const STACK_TO_ENUM = {
      'Frontend': 'FRONTEND',
      'Backend': 'BACKEND',
      'AI': 'AI',
      'Gaming': 'GAMING',
      'Mobile': 'MOBILE',
      'DevOps': 'DEVOPS'
    };
    const ENUM_TO_STACK_LABEL = Object.fromEntries(Object.entries(STACK_TO_ENUM).map(([k, v]) => [v, k]));

    const LANG_TO_ENUM = {
      'Java': 'JAVA',
      'Python': 'PYTHON',
      'JavaScript': 'JAVASCRIPT',
      'TypeScript': 'TYPESCRIPT',
      'PHP': 'PHP',
      'C#': 'C_SHARP',
      'C++': 'C_PLUS_PLUS',
      'Go': 'GO',
      'Rust': 'RUST',
      'Swift': 'SWIFT',
      'Kotlin': 'KOTLIN'
    };
    const ENUM_TO_LANG_LABEL = Object.fromEntries(Object.entries(LANG_TO_ENUM).map(([k, v]) => [v, k]));

    /**
     * Helpers imagine
     */
    const imageFor = (course) =>
      course.image || `https://picsum.photos/seed/fdc-${encodeURIComponent(course.slug || course.id)}/640/360`;

    /**
     * Favorites + ‚ÄûVƒÉzute recent‚Äù
     */
    const FAV_KEY = 'fdc:favorites';
    const VIEWED_KEY = 'fdc:viewed';
    const getFavs = () => new Set(JSON.parse(localStorage.getItem(FAV_KEY) || '[]'));
    const setFavs = set => localStorage.setItem(FAV_KEY, JSON.stringify([...set]));
    const getViewed = () => JSON.parse(localStorage.getItem(VIEWED_KEY) || '[]');
    function pushViewed(id) {
      const arr = getViewed().filter(x => String(x) !== String(id));
      arr.unshift(id);
      localStorage.setItem(VIEWED_KEY, JSON.stringify(arr.slice(0, 3)));
    }

    /**
     * Elemente
     */
    const els = {
      q: document.getElementById('q'),
      stack: document.getElementById('stack-select'),
      lang: document.getElementById('lang-select'),
      chips: document.getElementById('active-filters'),
      quick: document.getElementById('quick-chips'),
      res: document.getElementById('results'),
      reset: document.getElementById('reset-btn'),
      apply: document.getElementById('apply-btn'),
      menuBtn: document.getElementById('menuBtn'),
      sidebar: document.getElementById('sidebar'),
      overlay: document.getElementById('overlay'),
      modal: document.getElementById('courseModal'),
      modalClose: document.getElementById('modalClose'),
      modalTitle: document.getElementById('courseTitle'),
      modalSub: document.getElementById('courseSub'),
      modalDesc: document.getElementById('courseDesc'),
      modalBadges: document.getElementById('courseBadges'),
      rrTop: document.getElementById('rr-top'),
      rrRecent: document.getElementById('rr-recent'),
      pager: document.getElementById('pager'),
      // Popup buttons:
      addToCartBtn: document.getElementById('addToCart'),
      buyBtn: document.getElementById('buy'),
    };

    /**
     * Quick chips
     */
    const quickFilters = [
      { k: 'stack', v: 'Frontend', label: 'Frontend' },
      { k: 'stack', v: 'Backend', label: 'Backend' },
      { k: 'stack', v: 'AI', label: 'AI' },
      { k: 'stack', v: 'Gaming', label: 'Gaming' },
      { k: 'language', v: 'Java', label: 'Java' },
      { k: 'language', v: 'Python', label: 'Python' },
      { k: 'language', v: 'C#', label: 'C#' },
    ];

    function renderQuickChips() {
      els.quick.innerHTML = '';
      quickFilters.forEach(qf => {
        const b = document.createElement('button');
        b.className = 'tag'; b.type = 'button'; b.textContent = qf.label;
        b.onclick = () => {
          if (qf.k === 'stack') els.stack.value = qf.v; else els.lang.value = qf.v;
          state.page = 1;
          applyFilters();
        };
        els.quick.appendChild(b);
      });
    }

    /**
     * State cu paginare pe server
     */
    const state = { q: '', stack: '', lang: '', page: 1, pageSize: DEFAULT_PAGE_SIZE };

    function readState() {
      state.q = els.q.value.trim();
      state.stack = STACK_TO_ENUM[els.stack.value] || '';
      state.lang = LANG_TO_ENUM[els.lang.value] || '';
      return { ...state };
    }

    async function fetchCourses(st) {
      const p = new URLSearchParams();
      if (st.q) p.set('q', st.q);
      if (st.stack) p.set('stack', st.stack);
      if (st.lang) p.set('lang', st.lang);
      p.set('page', st.page);
      p.set('size', st.pageSize);

      const res = await fetch(`${REMOTE_JSON_URL}?${p.toString()}`, { cache: 'no-store' });
      if (!res.ok) throw new Error('Nu pot √ÆncƒÉrca lista de cursuri');
      return await res.json(); // { items, page, pageSize, total, totalPages }
    }

    function humanStack(code) { return ENUM_TO_STACK_LABEL[code] || code || '‚Äî'; }
    function humanLang(code) { return ENUM_TO_LANG_LABEL[code] || code || '‚Äî'; }

    function renderChips(st) {
      els.chips.innerHTML = '';
      const add = (label, onRemove) => {
        const s = document.createElement('span'); s.className = 'tag'; s.textContent = label;
        const x = document.createElement('button'); x.className = 'btn ghost'; x.textContent = '√ó';
        x.style.marginLeft = '6px'; x.onclick = onRemove; x.ariaLabel = 'EliminƒÉ filtru';
        s.appendChild(x); els.chips.appendChild(s);
      };
      if (st.q) add(`CƒÉutare: "${st.q}"`, () => { els.q.value = ''; state.page = 1; applyFilters(); });
      if (st.stack) add(`Stack: ${humanStack(st.stack)}`, () => { els.stack.value = ''; state.page = 1; applyFilters(); });
      if (st.lang) add(`Limbaj: ${humanLang(st.lang)}`, () => { els.lang.value = ''; state.page = 1; applyFilters(); });
    }

    /**
     * ===== Pre»õ (RON) =====
     */
    function normalizePrice(course) {
      if (!course || course.price == null || course.price === '') return null;
      const currency = course.currency || 'RON';
      const toNum = v => (typeof v === 'number') ? v : Number(String(v).replace(',', '.'));
      const p = toNum(course.price);
      if (Number.isNaN(p)) return null;
      const fmt = v => new Intl.NumberFormat('ro-RO', { style: 'currency', currency }).format(v);
      const label = p === 0 ? 'Gratuit' : fmt(p);
      return { value: p, label, compare: null, compareLabel: null, discountPct: 0 };
    }

    function priceHtml(course) {
      const pr = normalizePrice(course);
      if (!pr) return `<div class="price"><strong class="now">‚Äî</strong></div>`;
      return `<div class="price"><strong class="now">${pr.label}</strong></div>`;
    }

    /**
     * ===== API co»ô =====
     */
    async function getCartSummary() {
      const res = await fetch(CART_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error('Nu pot √ÆncƒÉrca co»ôul.');
      return res.json(); // { count, total, items: [{courseId,title,price}] }
    }

    async function addToCart(courseId) {
      const res = await fetch(CART_ADD_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ courseId })
      });
      if (!res.ok) throw new Error('Nu am putut adƒÉuga √Æn co»ô.');
      return res.json();
    }

    async function removeFromCart(courseId) {
      const res = await fetch(`${CART_ADD_URL}/${courseId}`, { method: 'DELETE' });
      if (!res.ok) throw new Error('Nu am putut scoate din co»ô.');
      return res.json();
    }

    function renderAddBtn(inCart) {
      const btn = els.addToCartBtn;
      if (!btn) return;
      btn.textContent = inCart ? 'Scoate din co»ô' : 'AdaugƒÉ √Æn co»ô';
      btn.dataset.inCart = inCart ? '1' : '0';
      btn.classList.toggle('danger', inCart);
    }

    async function syncAddBtnState(courseId) {
      const btn = els.addToCartBtn;
      if (!btn) return;
      btn.disabled = true;
      try {
        const cart = await getCartSummary();
        const inCart = Array.isArray(cart.items) && cart.items.some(i => String(i.courseId) === String(courseId));
        renderAddBtn(inCart);
      } catch {
        renderAddBtn(false);
      } finally {
        btn.disabled = false;
      }
    }

    async function buyNow(courseId) {
      await addToCart(courseId);
      window.location.href = CHECKOUT_URL;
    }

    /**
     * Card + listƒÉ
     */
    function toCardHtml(c) {
      const stackLabel = humanStack(c.stack);
      const langLabel = humanLang(c.language);
      const tags = (c.tags || []).slice(0, 6);
      const lastUpd = c.lastUpdated ? ` ¬∑ ${c.lastUpdated}` : '';
      return `
      <article class="card" tabindex="0" data-id="${c.id}">
        <div class="card-img">
          <img src="${imageFor(c)}" alt="MiniaturƒÉ curs: ${c.title}">
        </div>
        <div class="card-head">
          <span class="stack">${stackLabel} ¬∑ ${langLabel}${lastUpd}</span>
          <button class="fav" aria-label="AdaugƒÉ la cursurile mele" data-id="${c.id}">‚òÖ</button>
        </div>
        <div class="card-body">
          <h3><a href="${c.url}" class="title-link">${c.title}</a></h3>
          <div class="meta">
            ${tags.map(t => `<span class='tag'>${t}</span>`).join('')}
          </div>
          ${c.description ? `<p class="m">${c.description}</p>` : ``}
        </div>
        <div class="card-foot">
          <button class="btn primary buy" data-id="${c.id}">${priceHtml(c)}</button>
        </div>
      </article>`;
    }

    function renderPagerFromDto(dto) {
      els.pager.innerHTML = '';
      const totalPages = Math.max(1, dto.totalPages || 1);
      const cur = Math.max(1, dto.page || 1);

      const mkBtn = (label, page, disabled = false, active = false) => {
        const b = document.createElement('button');
        b.className = 'pbtn' + (active ? ' active' : '');
        b.textContent = label;
        b.disabled = disabled;
        b.onclick = () => { state.page = page; applyFilters(); };
        return b;
      };
      els.pager.appendChild(mkBtn('¬´', 1, cur === 1));
      els.pager.appendChild(mkBtn('‚Äπ', Math.max(1, cur - 1), cur === 1));

      const windowSize = 7;
      let start = Math.max(1, cur - Math.floor(windowSize / 2));
      let end = Math.min(totalPages, start + windowSize - 1);
      start = Math.max(1, Math.min(start, end - windowSize + 1));
      for (let p = start; p <= end; p++) {
        els.pager.appendChild(mkBtn(String(p), p, false, p === cur));
      }

      els.pager.appendChild(mkBtn('‚Ä∫', Math.min(totalPages, cur + 1), cur === totalPages));
      els.pager.appendChild(mkBtn('¬ª', totalPages, cur === totalPages));
    }

    let allCourses = []; // pentru right-rail & modal

    function renderRightRailTop(list) {
      const src = (list && list.length ? list : allCourses).slice();
      src.sort((a, b) => String(b.lastUpdated || '').localeCompare(String(a.lastUpdated || '')));
      const top = src.slice(0, 5);
      els.rrTop.innerHTML = top.map(c => `
        <a class="rr-item" href="${c.url}" data-id="${c.id}" style="text-decoration:none; color: var(--text);">
          <img src="${imageFor(c)}" alt="">
          <div>
            <div class="t">${c.title}</div>
            <div class="m">${humanStack(c.stack)} ¬∑ ${humanLang(c.language)}</div>
          </div>
        </a>`).join('');
    }

    function renderRightRailRecent() {
      const ids = getViewed();
      if (!ids.length) { els.rrRecent.innerHTML = `<div class="m">‚Äî</div>`; return; }
      const items = ids.map(id => allCourses.find(c => String(c.id) === String(id))).filter(Boolean);
      els.rrRecent.innerHTML = items.map(c => `
        <a class="rr-item" href="${c.url}" data-id="${c.id}" style="text-decoration:none; color: var(--text);">
          <img src="${imageFor(c)}" alt="">
          <div>
            <div class="t">${c.title}</div>
            <div class="m">${humanStack(c.stack)}</div>
          </div>
        </a>`).join('');
    }

    /**
     * Drawer + Overlay + Modal
     */
    function openDrawer() {
      els.sidebar?.classList.add('open'); showOverlay(true);
      els.menuBtn?.setAttribute('aria-expanded', 'true');
      document.addEventListener('keydown', onEscClose);
    }
    function closeDrawer() {
      els.sidebar?.classList.remove('open'); hideOverlay();
      els.menuBtn?.setAttribute('aria-expanded', 'false');
      document.removeEventListener('keydown', onEscClose);
      els.menuBtn?.focus();
    }
    function onEscClose(e){ if(e.key==='Escape'){ if(isModalOpen()) closeModal(); else closeDrawer(); } }
    els.menuBtn?.addEventListener('click', () => {
      const isOpen = els.sidebar?.classList.contains('open');
      isOpen ? closeDrawer() : openDrawer();
    });

    // √énchide modalul c√¢nd se dƒÉ click √Æn afara panoului
    els.modal.addEventListener('mousedown', (e) => {
      if (!e.target.closest('.modal-panel')) {
        e.preventDefault();
        closeModal();
      }
    });

    function showOverlay(lockScroll=false){ els.overlay?.classList.add('show'); if (els.overlay) els.overlay.hidden=false; if(lockScroll) document.body.style.overflow='hidden'; }
    function hideOverlay(){ if(!isModalOpen() && !els.sidebar?.classList.contains('open')){ els.overlay?.classList.remove('show'); if (els.overlay) els.overlay.hidden=true; document.body.style.overflow=''; } }
    els.overlay?.addEventListener('click', () => { if (isModalOpen()) closeModal(); if (els.sidebar?.classList.contains('open')) closeDrawer(); });

    let lastFocusEl=null;
    function isModalOpen(){ return els.modal.classList.contains('open'); }

    function openModal(course){
      if (els.sidebar?.classList.contains('open')) closeDrawer();
      lastFocusEl = document.activeElement;

      els.modalTitle.textContent = course.title;
      els.modalSub.textContent = `${humanStack(course.stack)} ¬∑ ${humanLang(course.language)}${course.lastUpdated ? ' ¬∑ actualizat la ' + course.lastUpdated : ''}`;
      els.modalDesc.textContent = course.description || '‚Äî';
      els.modalBadges.innerHTML = (course.tags || []).map(t => `<span class="pill">${t}</span>`).join('');

      // Cover
      const cover = document.getElementById('detailCover');
      if (cover) { cover.src = imageFor(course); cover.alt = `Imagine curs: ${course.title}`; }

      // Cuprins
      const toc = document.getElementById('courseToc');
      if (toc) {
        if (course.chapters && course.chapters.length) {
          toc.innerHTML = course.chapters.map(ch => `
            <div class="ch">
              <div class="ch-title"><span>${ch.position ?? ''}.</span> <span>${ch.title}</span></div>
              <div class="ls">
                ${(ch.lessons || []).map(ls => `<div>${ls.position ?? ''}. ${ls.title}</div>`).join('')}
              </div>
            </div>
          `).join('');
        } else {
          toc.innerHTML = `<div class="m">Nu existƒÉ capitole definite √ÆncƒÉ.</div>`;
        }
      }

      pushViewed(course.id);
      renderRightRailRecent();

      // === Toggle "AdaugƒÉ √Æn co»ô" ‚Üî "Scoate din co»ô" ===
      if (els.addToCartBtn) {
        els.addToCartBtn.dataset.id = course.id;
        syncAddBtnState(course.id); // seteazƒÉ textul ini»õial
        els.addToCartBtn.onclick = async () => {
          const btn = els.addToCartBtn;
          const id = Number(btn.dataset.id);
          const inCart = btn.dataset.inCart === '1';
          btn.disabled = true;
          try {
            if (inCart) {
              await removeFromCart(id);
              renderAddBtn(false);
            } else {
              await addToCart(id);
              renderAddBtn(true);
            }
          } catch (err) {
            alert(err.message || 'Eroare la actualizarea co»ôului.');
          } finally {
            btn.disabled = false;
          }
        };
      }

      // === CumpƒÉrƒÉ (add + redirect la checkout) ===
      if (els.buyBtn) {
        els.buyBtn.dataset.id = course.id;
        els.buyBtn.onclick = async () => {
          try {
            await addToCart(course.id);
            window.location.href = CHECKOUT_URL;
          } catch (err) {
            alert(err.message || 'Eroare la cumpƒÉrare.');
          }
        };
      }

      // Afi»ôare modal
      els.modal.hidden = false;
      els.modal.classList.add('open');
      showOverlay(true);
      els.modalClose?.focus();

      document.addEventListener('keydown', trapTab);
      document.addEventListener('keydown', onEscClose);
    }

    function closeModal(){
      els.modal.classList.remove('open'); els.modal.hidden = true; hideOverlay();
      document.removeEventListener('keydown', trapTab);
      document.removeEventListener('keydown', onEscClose);
      if (lastFocusEl) lastFocusEl.focus();
    }

    function trapTab(e){
      if(e.key!=='Tab') return;
      const focusables = els.modal.querySelectorAll('a,button,textarea,input,select,[tabindex]:not([tabindex="-1"])');
      if(!focusables.length) return;
      const first=focusables[0], last=focusables[focusables.length-1];
      if(e.shiftKey && document.activeElement===first){ last.focus(); e.preventDefault(); }
      else if(!e.shiftKey && document.activeElement===last){ first.focus(); e.preventDefault(); }
    }
    els.modalClose?.addEventListener('click', closeModal);

    /**
     * Evenimente listƒÉ
     */
    els.apply.addEventListener('click', () => { state.page = 1; applyFilters(); });
    els.reset.addEventListener('click', () => {
      els.q.value = ''; els.stack.value = ''; els.lang.value = '';
      state.page = 1; applyFilters();
    });
    els.q.addEventListener('keydown', e => { if (e.key === 'Enter') { state.page = 1; applyFilters(); } });

    els.res.addEventListener('click', async (e) => {
      const target = e.target;

      // Toggle stea "cursurile mele"
      const favBtn = target.closest('button.fav');
      if (favBtn) {
        const id = favBtn.dataset.id;
        const favs = getFavs();
        if (favs.has(String(id))) favs.delete(String(id)); else favs.add(String(id));
        setFavs(favs);
        applyFilters();
        e.stopPropagation(); return;
      }

      // CumpƒÉrƒÉ direct din card (butonul cu pre»õ)
      const buyBtn = target.closest('button.buy');
      if (buyBtn) {
        const id = buyBtn.dataset.id;
        buyNow(Number(id)).catch(err => alert(err.message || 'Eroare la cumpƒÉrare'));
        e.stopPropagation(); return;
      }

      // Click pe titlu => modal
      if (target.closest('a.title-link')) {
        e.preventDefault();
        const card = target.closest('.card');
        const id = card?.dataset.id;
        const course = allCourses.find(c => String(c.id) === String(id));
        if (course) openModal(course);
        return;
      }

      // Click pe card => modal
      const card = target.closest('.card');
      if (card) {
        const id = card.dataset.id;
        const course = allCourses.find(c => String(c.id) === String(id));
        if (course) openModal(course);
      }
    });

    els.res.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const card = e.target.closest('card');
        if (card) {
          const id = card.dataset.id;
          const course = allCourses.find(c => String(c.id) === String(id));
          if (course) openModal(course);
        }
      }
    });

    /**
     * √éncƒÉrcare + render
     */
    async function applyFilters() {
      const st = readState();
      renderChips(st);
      try {
        const dto = await fetchCourses(st);
        allCourses = Array.isArray(dto.items) ? dto.items : [];
        els.res.innerHTML = allCourses.length
          ? allCourses.map(toCardHtml).join('')
          : `<div class="empty">N-am gƒÉsit nimic. √éncearcƒÉ sƒÉ lƒÉrge»ôti cƒÉutarea.</div>`;
        renderPagerFromDto(dto);
        renderRightRailTop(allCourses);
        renderRightRailRecent();
      } catch (e) {
        els.res.innerHTML = `<div class="empty">Eroare la √ÆncƒÉrcarea cursurilor.</div>`;
        els.pager.innerHTML = '';
      }
    }

    // Init
    renderQuickChips();
    applyFilters();
</script>
</body>
</html>
