<!DOCTYPE html>
<html lang="ro" xmlns:th="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Fabrica de Coduri â€“ Dashboard</title>
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
</head>

<body>

<div class="topbar" role="banner">
    <button id="menuBtn" class="hamburger" aria-label="Deschide meniul" aria-controls="sidebar"
            aria-expanded="false">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M4 7h16M4 12h16M4 17h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>
    </button>
</div>

<div class="app">
    <div th:replace="~{fragments/left-menu :: left-menu}"></div>
    <main>
        <header class="toolbar">
            <div class="searchbar" role="search">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M21 21l-4.2-4.2" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2" />
                </svg>
                <input id="q" type="search"
                       placeholder="CautÄƒ cursuri, limbaje, topicuriâ€¦ (ex: Spring, Python OOP)" />
            </div>

            <select id="stack-select" aria-label="Filtru stack">
                <option value="">Toate stack-urile</option>
                <option value="Frontend">Frontend</option>
                <option value="Backend">Backend</option>
                <option value="AI">AI</option>
                <option value="Gaming">Gaming</option>
                <option value="Mobile">Mobile</option>
                <option value="DevOps">DevOps</option>
            </select>

            <select id="lang-select" aria-label="Filtru limbaj">
                <option value="">Toate limbajele</option>
                <option>Java</option>
                <option>Python</option>
                <option>JavaScript</option>
                <option>TypeScript</option>
                <option>PHP</option>
                <option>C#</option>
                <option>C++</option>
                <option>Go</option>
                <option>Rust</option>
                <option>Swift</option>
                <option>Kotlin</option>
            </select>

            <button class="btn" id="reset-btn" title="ReseteazÄƒ filtrele">Reset</button>
            <button class="btn primary" id="apply-btn">AplicÄƒ</button>
        </header>

        <div class="content">
            <div>
                <section class="chips" id="active-filters"></section>

                <section id="results" class="grid" aria-live="polite"></section>
                <nav id="pager" class="pager" aria-label="Paginare"></nav>
            </div>
            <aside class="right-rail" aria-label="RecomandÄƒri È™i promoÈ›ii">
                <div class="rr-card" id="rr-promo">
                    <h4>ğŸ‰ Promo septembrie</h4>
                    <p style="margin:6px 0 10px">-25% la pachetele <strong>Backend</strong> & <strong>AI</strong>
                        pÃ¢nÄƒ la <strong>30 sept</strong>.</p>
                    <div class="rr-cta">
                        <a class="btn primary" href="/oferta">Prinde oferta</a>
                        <a class="btn" href="/pachete">Vezi pachete</a>
                    </div>
                    <p class="m" style="margin-top:8px;color:var(--muted);font-size:12px">GaranÈ›ie 14 zile
                        money-back.</p>
                </div>

                <div class="rr-card">
                    <h4>â­ Top cursuri</h4>
                    <div class="rr-list" id="rr-top"></div>
                </div>

                <div class="rr-card">
                    <h4>ğŸ•’ VÄƒzute recent</h4>
                    <div class="rr-list" id="rr-recent"></div>
                </div>
            </aside>
        </div>
    </main>
</div>

<!-- Overlay (reutilizat pentru modal & drawer) -->
<div class="overlay" id="overlay" hidden></div>

<!-- Modal curs -->
<div id="courseModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="courseTitle"
     aria-describedby="courseDesc" hidden>
    <div class="modal-panel">
        <header class="modal-head">
            <div>
                <h2 id="courseTitle" class="modal-title"></h2>
                <p class="modal-sub" id="courseSub"></p>
            </div>
            <button id="modalClose" class="icon-btn" aria-label="Ãnchide detaliile cursului">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                </svg>
            </button>
        </header>
        <div class="modal-body">
            <div id="courseBadges" class="chips"></div>
            <p id="courseDesc"></p>

            <div>
                <strong>Ce vei Ã®nvÄƒÈ›a</strong>
                <ul id="courseLearn" class="list"></ul>
            </div>

            <div>
                <strong>CerinÈ›e</strong>
                <ul id="courseReq" class="list"></ul>
            </div>
        </div>
        <footer class="modal-foot">
            <a id="courseLink" class="btn">Mergi la curs</a>
            <button id="modalFav" class="btn">AdaugÄƒ la cursurile mele</button>
        </footer>
    </div>
</div>

<script>
    /**
     * ====== CONFIG UÈ˜OR DE SCHIMBAT ======
     */
    const REMOTE_JSON_URL = '/data/courses.json'; // cÃ¢nd backend-ul e gata, lasÄƒ-l aÈ™a
    const DEFAULT_PAGE_SIZE = 9;                   // cÃ¢te carduri pe paginÄƒ
    const MAX_AUTOGEN = 60;                        // cÃ¢te cursuri sÄƒ genereze pentru mock lung

    /**
     * imaginile: folosim un seed determinist pentru poze 16:9 ca placeholder,
     * uÈ™or de swap-uit ulterior cu CDN-ul tÄƒu; dacÄƒ backend-ul trimite `image`,
     * folosim exact ce vine din JSON.
     */
    const imageFor = (course) =>
        course.image ||
        `https://picsum.photos/seed/fdc-${encodeURIComponent(course.language || 'code')}-${course.id}/640/360`;

    /**
     * mock de bazÄƒ (din ce ai avut) â€” Ã®l extindem mai jos Ã®n generator
     * (am adÄƒugat doar cÃ¢mpul "image")
     */
    const baseCourses = [
        {
            id: 1, title: "Java â€“ Introducere Ã®n Spring Boot", stack: "Backend", language: "Java", level: "ÃncepÄƒtor", duration: "5h",
            tags: ["Spring", "REST", "Thymeleaf"], url: "/lectii/java/spring-boot-intro",
            subtitle: "ConstruieÈ™te API-uri REST & aplicaÈ›ii MVC rapid cu Spring.",
            description: "Ãn acest curs vei Ã®nÈ›elege ecosistemul Spring È™i vei crea o aplicaÈ›ie completÄƒ cu controller-e, servicii È™i persistenta datelor.",
            learn: ["Crearea proiectelor cu Spring Initializr", "REST controllers & validare", "PersistenÈ›Äƒ cu Spring Data JPA", "Thymeleaf pentru pagini simple"],
            requirements: ["Java de bazÄƒ (tipuri, OOP)", "Maven/Gradle instalat"],
            author: "Ana Ionescu", rating: 4.7, lastUpdated: "2025-05-10", image: ""
        },
        {
            id: 2, title: "Python â€“ Bazele limbajului", stack: "Backend", language: "Python", level: "ÃncepÄƒtor", duration: "4h",
            tags: ["SintaxÄƒ", "OOP", "ColecÈ›ii"], url: "/lectii/python/baze",
            subtitle: "De la zero la scripturi utile Ã®n cÃ¢teva ore.",
            description: "Acoperim sintaxa, structurile de date, funcÈ›ii, clase È™i interacÈ›iunea cu fiÈ™iere pentru a-È›i construi fundaÈ›ia Python.",
            learn: ["List/dict/tuple & comprehensions", "FuncÈ›ii, module, pachete", "OOP pe scurt", "Citire/scriere fiÈ™iere"],
            requirements: ["Zero experienÈ›Äƒ sau bazÄƒ minimalÄƒ", "Python 3 instalat"],
            author: "Mihai Pop", rating: 4.8, lastUpdated: "2025-03-02", image: ""
        },
        {
            id: 3, title: "JavaScript â€“ DOM & evenimente", stack: "Frontend", language: "JavaScript", level: "ÃncepÄƒtor", duration: "3h",
            tags: ["DOM", "Events", "Browser"], url: "/lectii/js/dom",
            subtitle: "ManipuleazÄƒ DOM-ul ca un pro È™i rÄƒspunde la interacÈ›iunile utilizatorilor.",
            description: "ÃnveÈ›i selecÈ›ii, modificÄƒri de noduri, delegare de evenimente È™i tipare mici pentru UI reactiv.",
            learn: ["querySelector & traversare", "Creare/È™tergere elemente", "Delegare de evenimente", "Debounce & throttle"],
            requirements: ["Bazele JS", "Browser modern"],
            author: "Ioana Radu", rating: 4.6, lastUpdated: "2025-04-14", image: ""
        },
        {
            id: 4, title: "TypeScript â€“ Tipuri È™i generice", stack: "Frontend", language: "TypeScript", level: "Intermediar", duration: "3h",
            tags: ["Types", "Generics"], url: "/lectii/ts/tipuri",
            subtitle: "Scrie JS mai sigur cu tipuri solide.",
            description: "Tipuri avansate, generice È™i utility types pentru proiecte reale.",
            learn: ["Union/intersection", "Generic functions", "Mapped & conditional types", "Definirea tipurilor pentru API-uri"],
            requirements: ["JS/TS de bazÄƒ", "Editor cu suport TS"],
            author: "Andrei Luca", rating: 4.7, lastUpdated: "2025-02-20", image: ""
        },
        {
            id: 5, title: "PHP â€“ ConstruieÈ™te un API simplu", stack: "Backend", language: "PHP", level: "Intermediar", duration: "4h",
            tags: ["API", "Routing", "PDO"], url: "/lectii/php/api",
            subtitle: "Un micro-API REST cu routing, PDO È™i autentificare simplÄƒ.",
            description: "Proiect practic ce acoperÄƒ routing, controller-e, acces la DB È™i erori.",
            learn: ["Router custom", "PDO & prepared statements", "StructurÄƒ de proiect", "Middleware simplu"],
            requirements: ["PHP 8.x", "MySQL/MariaDB"],
            author: "Raluca S.", rating: 4.5, lastUpdated: "2025-01-11", image: ""
        },
        {
            id: 6, title: "C# â€“ Programare orientatÄƒ pe obiecte", stack: "Backend", language: "C#", level: "ÃncepÄƒtor", duration: "4h",
            tags: ["OOP", ".NET"], url: "/lectii/csharp/oop",
            subtitle: "Clase, moÈ™tenire, interfeÈ›e Ã®n .NET.",
            description: "Conceptual È™i practic despre OOP Ã®n C# cu exemple uÈ™or de urmat.",
            learn: ["Clase & obiecte", "MoÈ™tenire/polimorfism", "InterfeÈ›e & abstract", "ColecÈ›ii generice"],
            requirements: ["C# de bazÄƒ", "SDK .NET instalat"],
            author: "Vlad Marin", rating: 4.6, lastUpdated: "2025-06-01", image: ""
        },
        {
            id: 7, title: "Rust â€“ Ownership & Borrowing", stack: "Backend", language: "Rust", level: "Avansat", duration: "2h",
            tags: ["Memory", "Borrow Checker"], url: "/lectii/rust/ownership",
            subtitle: "ÃnÈ›elege siguranÈ›a memoriei cu ownership/borrowing.",
            description: "ExplorÄƒm regulile de ownership, lifetimes È™i cum te ajutÄƒ borrow checker-ul.",
            learn: ["Ownership & moves", "References & borrowing", "Lifetimes pe scurt", "Erori comune & fixuri"],
            requirements: ["Rust de bazÄƒ", "Cargo instalat"],
            author: "Teo M.", rating: 4.9, lastUpdated: "2025-07-18", image: ""
        },
        {
            id: 8, title: "Go â€“ ConcurenÈ›Äƒ cu goroutines", stack: "Backend", language: "Go", level: "Intermediar", duration: "2.5h",
            tags: ["Goroutines", "Channels"], url: "/lectii/go/concurrency",
            subtitle: "Canale, goroutines È™i pattern-uri concurente.",
            description: "Construim componente concurente È™i discutÄƒm sincronizarea & erorile.",
            learn: ["Spawn & sync", "Channels & select", "Worker pools", "Context & timeout"],
            requirements: ["Go de bazÄƒ", "Go toolchain instalat"],
            author: "Alex P.", rating: 4.7, lastUpdated: "2025-05-28", image: ""
        },
        {
            id: 9, title: "AI â€“ Introducere Ã®n Machine Learning", stack: "AI", language: "Python", level: "ÃncepÄƒtor", duration: "6h",
            tags: ["ML", "Scikit-learn"], url: "/lectii/ai/ml-intro",
            subtitle: "Conceptele fundamentale ML cu scikit-learn.",
            description: "De la preprocesare la evaluare modele, hands-on pe dataset-uri reale.",
            learn: ["Split train/test", "Pipelines & GridSearch", "Regresie/clasificare", "Metrici & bias/variance"],
            requirements: ["Python bazÄƒ", "NoÈ›iuni de matematicÄƒ"],
            author: "Ana Ionescu", rating: 4.8, lastUpdated: "2025-08-09", image: ""
        },
        {
            id: 10, title: "Gaming â€“ Unity pentru Ã®ncepÄƒtori", stack: "Gaming", language: "C#", level: "ÃncepÄƒtor", duration: "5h",
            tags: ["Unity", "Scenes", "Physics"], url: "/lectii/gaming/unity",
            subtitle: "Primul tÄƒu joc 2D/3D cu Unity.",
            description: "Scene, prefabs, physics & scripting â€“ tot ce-È›i trebuie pentru start.",
            learn: ["Scene & prefabs", "Rigidbodies & coliziuni", "UI & input", "Build & deploy"],
            requirements: ["PC/Mac cu Unity", "C# bazÄƒ"],
            author: "Mara D.", rating: 4.6, lastUpdated: "2025-04-30", image: ""
        },
        {
            id: 11, title: "Frontend â€“ Layout modern cu CSS Grid", stack: "Frontend", language: "JavaScript", level: "Intermediar", duration: "2h",
            tags: ["CSS", "Grid", "Responsive"], url: "/lectii/frontend/css-grid",
            subtitle: "Layout-uri fluide È™i curate cu CSS Grid.",
            description: "ÃnveÈ›i track-uri, areas, auto-fit, minmax È™i pattern-uri responsive.",
            learn: ["Grid areas", "Auto-fit/auto-fill", "Minmax & fr units", "Fallback & accesibilitate"],
            requirements: ["HTML/CSS bazÄƒ"], author: "Ioana Radu", rating: 4.7, lastUpdated: "2025-02-01", image: ""
        },
        {
            id: 12, title: "Mobile â€“ Kotlin & Jetpack Compose", stack: "Mobile", language: "Kotlin", level: "Intermediar", duration: "4h",
            tags: ["Android", "Compose"], url: "/lectii/mobile/compose",
            subtitle: "UI declarativ modern pe Android.",
            description: "State, recomposition, theming È™i navigaÈ›ie cu Compose.",
            learn: ["Composables & state", "Lists & lazy", "Theming", "Navigation"],
            requirements: ["Kotlin bazÄƒ", "Android Studio"],
            author: "Andrei Luca", rating: 4.6, lastUpdated: "2025-03-18", image: ""
        },
        {
            id: 13, title: "DevOps â€“ CI/CD de bazÄƒ", stack: "DevOps", language: "JavaScript", level: "ÃncepÄƒtor", duration: "2h",
            tags: ["CI", "CD", "GitHub Actions"], url: "/lectii/devops/ci-cd",
            subtitle: "AutomatizeazÄƒ build/test/deploy cu GitHub Actions.",
            description: "Pipeline minimal de la push la producÈ›ie, cu secrete È™i matrice.",
            learn: ["Workflows & jobs", "Cache & matrice", "Environments & secrets", "Artefacte & deploy"],
            requirements: ["Git & repo pe GitHub"], author: "Vlad Marin", rating: 4.5, lastUpdated: "2025-05-05", image: ""
        }
    ];

    /**
     * generator de multe cursuri pe baza â€baseCoursesâ€
     */
    function expandMock(base, countWanted = MAX_AUTOGEN) {
        const stacks = ["Frontend", "Backend", "AI", "Gaming", "Mobile", "DevOps"];
        const langs = ["Java", "Python", "JavaScript", "TypeScript", "PHP", "C#", "C++", "Go", "Rust", "Swift", "Kotlin"];
        const levels = ["ÃncepÄƒtor", "Intermediar", "Avansat"];
        const extraTags = ["API", "Testing", "Security", "Performance", "Cloud", "K8s", "Docker", "React", "Vue", "SQL", "NoSQL", "Design Patterns"];

        const out = [];
        const startId = Math.max(...base.map(c => c.id)) + 1;
        let id = startId;

        // pÄƒstrÄƒm ce ai deja
        out.push(...base.map(c => ({ ...c, image: imageFor(c) })));

        while (out.length < countWanted) {
            const sample = base[(id - 1) % base.length];
            const stack = stacks[id % stacks.length];
            const language = langs[id % langs.length];
            const level = levels[id % levels.length];

            const title = `${language} â€“ ${sample.title.split("â€“")[1]?.trim() || "Workshop practic"} #${id}`;
            const duration = (2 + (id % 5)) + "h";
            const rating = (4 + ((id % 10) / 10)).toFixed(1);
            const tags = Array.from(new Set([...(sample.tags || []), extraTags[id % extraTags.length]])).slice(0, 4);

            out.push({
                ...sample,
                id,
                title,
                stack,
                language,
                level,
                duration,
                tags,
                rating: Number(rating),
                lastUpdated: `2025-${String((id % 12) + 1).padStart(2, '0')}-${String((id % 27) + 1).padStart(2, '0')}`,
                url: `/lectii/${language.toLowerCase().replace(/[#+]/g, 'sharp')}/${title.toLowerCase().replace(/[^a-z0-9]+/gi, '-')}`,
                image: imageFor({ id, language })
            });
            id++;
        }
        return out;
    }

    /**
     * storage â€Cursurile meleâ€ + â€VÄƒzute recentâ€
     */
    const FAV_KEY = 'fdc:favorites';
    const VIEWED_KEY = 'fdc:viewed';
    const getFavs = () => new Set(JSON.parse(localStorage.getItem(FAV_KEY) || '[]'));
    const setFavs = set => localStorage.setItem(FAV_KEY, JSON.stringify([...set]));
    function getViewed() { return JSON.parse(localStorage.getItem(VIEWED_KEY) || '[]'); }
    function pushViewed(id) {
        const arr = getViewed().filter(x => String(x) !== String(id));
        arr.unshift(id);
        localStorage.setItem(VIEWED_KEY, JSON.stringify(arr.slice(0, 3)));
    }

    const els = {
        q: document.getElementById('q'),
        stack: document.getElementById('stack-select'),
        lang: document.getElementById('lang-select'),
        chips: document.getElementById('active-filters'),
        quick: document.getElementById('quick-chips'),
        res: document.getElementById('results'),
        reset: document.getElementById('reset-btn'),
        apply: document.getElementById('apply-btn'),
        menuBtn: document.getElementById('menuBtn'),
        sidebar: document.getElementById('sidebar'),
        overlay: document.getElementById('overlay'),
        modal: document.getElementById('courseModal'),
        modalClose: document.getElementById('modalClose'),
        modalTitle: document.getElementById('courseTitle'),
        modalSub: document.getElementById('courseSub'),
        modalDesc: document.getElementById('courseDesc'),
        modalBadges: document.getElementById('courseBadges'),
        modalLearn: document.getElementById('courseLearn'),
        modalReq: document.getElementById('courseReq'),
        modalLink: document.getElementById('courseLink'),
        modalFav: document.getElementById('modalFav'),
        pager: document.getElementById('pager'),
        rrTop: document.getElementById('rr-top'),
        rrRecent: document.getElementById('rr-recent'),
    };

    const quickFilters = [
        { k: 'stack', v: 'Frontend', label: 'Frontend' },
        { k: 'stack', v: 'Backend', label: 'Backend' },
        { k: 'stack', v: 'AI', label: 'AI' },
        { k: 'stack', v: 'Gaming', label: 'Gaming' },
        { k: 'language', v: 'Java', label: 'Java' },
        { k: 'language', v: 'Python', label: 'Python' },
        { k: 'language', v: 'C#', label: 'C#' },
    ];

    function renderQuickChips() {
        els.quick.innerHTML = '';
        quickFilters.forEach(qf => {
            const b = document.createElement('button');
            b.className = 'tag'; b.type = 'button'; b.textContent = qf.label;
            b.onclick = () => {
                if (qf.k === 'stack') els.stack.value = qf.v; else els.lang.value = qf.v;
                state.page = 1; // reset paginÄƒ la schimbare
                applyFilters();
            };
            els.quick.appendChild(b);
        });
    }

    /**
     * ====== STATE cu paginare ======
     */
    const state = {
        q: '',
        stack: '',
        lang: '',
        page: 1,
        pageSize: DEFAULT_PAGE_SIZE,
    };

    function readState() {
        state.q = els.q.value.trim().toLowerCase();
        state.stack = els.stack.value;
        state.lang = els.lang.value;
        return { ...state };
    }

    function courseMatch(course, st) {
        const t = (course.title + ' ' + (course.tags || []).join(' ') + ' ' + course.level + ' ' + course.stack + ' ' + course.language + ' ' + (course.subtitle || '') + ' ' + (course.description || '')).toLowerCase();
        const matchesQ = st.q ? t.includes(st.q) : true;
        const matchesStack = st.stack ? course.stack === st.stack : true;
        const matchesLang = st.lang ? course.language === st.lang : true;
        return matchesQ && matchesStack && matchesLang;
    }

    function renderChips(st) {
        els.chips.innerHTML = '';
        const add = (label, onRemove) => {
            const s = document.createElement('span'); s.className = 'tag'; s.textContent = label;
            const x = document.createElement('button'); x.className = 'btn ghost'; x.textContent = 'Ã—'; x.style.marginLeft = '6px'; x.onclick = onRemove; x.ariaLabel = 'EliminÄƒ filtru';
            s.appendChild(x); els.chips.appendChild(s);
        };
        if (st.q) add(`CÄƒutare: "${st.q}"`, () => { els.q.value = ''; state.page = 1; applyFilters(); });
        if (st.stack) add(`Stack: ${st.stack}`, () => { els.stack.value = ''; state.page = 1; applyFilters(); });
        if (st.lang) add(`Limbaj: ${st.lang}`, () => { els.lang.value = ''; state.page = 1; applyFilters(); });
    }

    function renderCourses(list) {
        els.res.innerHTML = '';
        if (!list.length) {
            const d = document.createElement('div'); d.className = 'empty';
            d.textContent = 'N-am gÄƒsit nimic pe baza filtrelor. ÃncearcÄƒ sÄƒ lÄƒrgeÈ™ti cÄƒutarea.';
            els.res.appendChild(d);
            return;
        }
        const favs = getFavs();
        list.forEach(c => {
            const card = document.createElement('article'); card.className = 'card'; card.tabIndex = 0; card.dataset.id = c.id;
            card.innerHTML = `
<div class="card-img">
<img src="${imageFor(c)}" alt="MiniaturÄƒ curs: ${c.title}">
</div>
<div class="card-head">
<span class="stack">${c.stack} Â· ${c.level} Â· ${c.duration}</span>
<button class="fav" aria-label="AdaugÄƒ la cursurile mele" data-id="${c.id}">â˜…</button>
</div>
<div class="card-body">
<h3><a href="${c.url}" class="title-link">${c.title}</a></h3>
<div class="meta">
<span class="tag">Limbaj: ${c.language}</span>
${(c.tags || []).map(t => `<span class='tag'>${t}</span>`).join('')}
<span class="tag">â­ ${c.rating ?? 'â€”'}</span>
</div>
</div>
<div class="card-foot">
<a class="btn view" href="${c.url}">CumparÄƒ</a>
<button class="btn add" data-id="${c.id}">${favs.has(String(c.id)) ? 'Scoate din wishlist' : 'AdaugÄƒ Ã®n wishlist'}</button>
</div>`;
            els.res.appendChild(card);
        });
    }

    function renderPager(total, st) {
        const totalPages = Math.max(1, Math.ceil(total / st.pageSize));
        st.page = Math.min(st.page, totalPages);
        els.pager.innerHTML = '';

        const mkBtn = (label, page, disabled = false, active = false) => {
            const b = document.createElement('button');
            b.className = 'pbtn' + (active ? ' active' : '');
            b.textContent = label;
            b.disabled = disabled;
            b.onclick = () => { state.page = page; applyFilters(); };
            return b;
        };

        els.pager.appendChild(mkBtn('Â«', 1, st.page === 1));
        els.pager.appendChild(mkBtn('â€¹', Math.max(1, st.page - 1), st.page === 1));

        const windowSize = 7;
        let start = Math.max(1, st.page - Math.floor(windowSize / 2));
        let end = Math.min(totalPages, start + windowSize - 1);
        start = Math.max(1, Math.min(start, end - windowSize + 1));

        for (let p = start; p <= end; p++) {
            els.pager.appendChild(mkBtn(String(p), p, false, p === st.page));
        }

        els.pager.appendChild(mkBtn('â€º', Math.min(totalPages, st.page + 1), st.page === totalPages));
        els.pager.appendChild(mkBtn('Â»', totalPages, st.page === totalPages));
    }

    function paginate(list, st) {
        const total = list.length;
        const start = (st.page - 1) * st.pageSize;
        const end = start + st.pageSize;
        return { total, pageItems: list.slice(start, end) };
    }

    function toggleFav(id) {
        const favs = getFavs();
        if (favs.has(String(id))) favs.delete(String(id)); else favs.add(String(id));
        setFavs(favs);
        applyFilters(); // re-render pentru a actualiza eticheta
    }

    /**
     * Right rail: Top cursuri (din filtrul curent) + VÄƒzute recent
     */
    function renderRightRailTop(filteredList) {
        const src = (filteredList.length >= 5 ? filteredList : allCourses).slice();
        src.sort((a, b) => (b.rating || 0) - (a.rating || 0) || String(b.lastUpdated).localeCompare(String(a.lastUpdated)));
        const top = src.slice(0, 5);
        els.rrTop.innerHTML = top.map(c => `
<a class="rr-item" href="${c.url}" data-id="${c.id}" style="text-decoration:none; color: var(--text);">
<img src="${imageFor(c)}" alt="">
<div>
<div class="t">${c.title}</div>
<div class="m">â­ ${c.rating ?? 'â€”'} Â· ${c.language}</div>
</div>
</a>
`).join('');

    }

    function renderRightRailRecent() {
        const ids = getViewed();
        if (!ids.length) { els.rrRecent.innerHTML = `<div class="m">â€”</div>`; return; }
        const items = ids.map(id => allCourses.find(c => String(c.id) === String(id))).filter(Boolean);
        els.rrRecent.innerHTML = items.map(c => `
<a class="rr-item" href="${c.url}" data-id="${c.id}" style="text-decoration:none; color: var(--text);">
<img src="${imageFor(c)}" alt="">
<div>
<div class="t">${c.title}</div>
<div class="m">${c.stack} Â· ${c.level}</div>
</div>
</a>
`).join('');
    }

    /**
     * ===== Drawer logic (mobil) + overlay (reutilizat) =====
     */
    function openDrawer() {
        els.sidebar.classList.add('open');
        showOverlay(true);
        els.menuBtn.setAttribute('aria-expanded', 'true');
        const firstLink = els.sidebar.querySelector('.nav-item');
        firstLink && firstLink.focus();
        document.addEventListener('keydown', onEscClose);
    }
    function closeDrawer() {
        els.sidebar.classList.remove('open');
        hideOverlay();
        els.menuBtn.setAttribute('aria-expanded', 'false');
        document.removeEventListener('keydown', onEscClose);
        els.menuBtn.focus();
    }
    function onEscClose(e) { if (e.key === 'Escape') { if (isModalOpen()) closeModal(); else closeDrawer(); } }

    els.menuBtn?.addEventListener('click', () => {
        const isOpen = els.sidebar.classList.contains('open');
        isOpen ? closeDrawer() : openDrawer();
    });

    function showOverlay(lockScroll = false) {
        els.overlay.classList.add('show');
        els.overlay.hidden = false;
        if (lockScroll) document.body.style.overflow = 'hidden';
    }
    function hideOverlay() {
        if (!isModalOpen() && !els.sidebar.classList.contains('open')) {
            els.overlay.classList.remove('show');
            els.overlay.hidden = true;
            document.body.style.overflow = '';
        }
    }
    els.overlay?.addEventListener('click', () => {
        if (isModalOpen()) closeModal();
        if (els.sidebar.classList.contains('open')) closeDrawer();
    });

    /**
     * ===== Modal =====
     */
    let lastFocusEl = null;
    function isModalOpen() { return els.modal.classList.contains('open'); }

    function openModal(course) {
        if (els.sidebar.classList.contains('open')) closeDrawer();

        lastFocusEl = document.activeElement;

        els.modalTitle.textContent = course.title;
        els.modalSub.textContent = `${course.stack} Â· ${course.level} Â· ${course.duration} â€” ${course.author} Â· actualizat la ${course.lastUpdated}`;
        els.modalDesc.textContent = course.description || 'â€”';
        els.modalBadges.innerHTML = `
<span class="pill">Limbaj: ${course.language}</span>
${(course.tags || []).map(t => `<span class="pill">${t}</span>`).join('')}
<span class="pill">â­ ${course.rating ?? 'â€”'}</span>
`;
        els.modalLearn.innerHTML = (course.learn || []).map(i => `<li>${i}</li>`).join('');
        els.modalReq.innerHTML = (course.requirements || []).map(i => `<li>${i}</li>`).join('');
        els.modalLink.href = course.url;
        els.modalFav.dataset.id = course.id;
        els.modalFav.textContent = getFavs().has(String(course.id)) ? 'Ãn cursurile mele' : 'AdaugÄƒ la cursurile mele';

        // imagine Ã®n header-ul modalului
        if (!els.modalTitle.nextElementSibling?.classList?.contains('modal-img')) {
            const img = document.createElement('img');
            img.src = imageFor(course);
            img.alt = `Imagine curs: ${course.title}`;
            img.className = 'modal-img';
            img.style.cssText = 'width:100%;max-height:260px;object-fit:cover;border-radius:10px;margin-top:8px;border:1px solid var(--border)';
            els.modalHeadAfterHook?.remove?.();
            els.modalTitle.parentElement.appendChild(img);
            els.modalHeadAfterHook = img;
        } else {
            els.modalHeadAfterHook.src = imageFor(course);
            els.modalHeadAfterHook.alt = `Imagine curs: ${course.title}`;
        }

        // mark as viewed + update right rail
        pushViewed(course.id);
        renderRightRailRecent();

        els.modal.hidden = false;
        els.modal.classList.add('open');
        showOverlay(true);
        els.modalClose.focus();

        document.addEventListener('keydown', trapTab);
        document.addEventListener('keydown', onEscClose);
    }

    function closeModal() {
        els.modal.classList.remove('open');
        els.modal.hidden = true;
        hideOverlay();
        document.removeEventListener('keydown', trapTab);
        document.removeEventListener('keydown', onEscClose);
        if (lastFocusEl) lastFocusEl.focus();
    }

    function trapTab(e) {
        if (e.key !== 'Tab') return;
        const focusables = els.modal.querySelectorAll('a,button,textarea,input,select,[tabindex]:not([tabindex="-1"])');
        if (!focusables.length) return;
        const first = focusables[0], last = focusables[focusables.length - 1];
        if (e.shiftKey && document.activeElement === first) { last.focus(); e.preventDefault(); }
        else if (!e.shiftKey && document.activeElement === last) { first.focus(); e.preventDefault(); }
    }

    els.modalClose.addEventListener('click', closeModal);
    els.modalFav.addEventListener('click', () => {
        const id = els.modalFav.dataset.id;
        toggleFav(id);
        els.modalFav.textContent = getFavs().has(String(id)) ? 'Ãn cursurile mele' : 'AdaugÄƒ la cursurile mele';
    });

    /**
     * ===== Evenimente UI listÄƒ =====
     */
    els.apply.addEventListener('click', () => { state.page = 1; applyFilters(); });
    els.reset.addEventListener('click', () => { els.q.value = ''; els.stack.value = ''; els.lang.value = ''; state.page = 1; applyFilters(); });
    els.q.addEventListener('keydown', e => { if (e.key === 'Enter') { state.page = 1; applyFilters(); } });

    // Delegare click pe lista de rezultate
    els.res.addEventListener('click', (e) => {
        const target = e.target;

        const addBtn = target.closest('button.add');
        if (addBtn) { toggleFav(addBtn.dataset.id); e.stopPropagation(); return; }

        const favBtn = target.closest('button.fav');
        if (favBtn) { toggleFav(favBtn.dataset.id); e.stopPropagation(); return; }

        if (target.closest('a.view')) { e.stopPropagation(); return; }

        if (target.closest('a.title-link')) {
            e.preventDefault();
            const card = target.closest('.card');
            const id = card?.dataset.id;
            const course = allCourses.find(c => String(c.id) === String(id));
            if (course) openModal(course);
            return;
        }

        const card = target.closest('.card');
        if (card) {
            const id = card.dataset.id;
            const course = allCourses.find(c => String(c.id) === String(id));
            if (course) openModal(course);
        }
    });

    // accesibilitate: Enter pe card
    els.res.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            const card = e.target.closest('.card');
            if (card) {
                const id = card.dataset.id;
                const course = allCourses.find(c => String(c.id) === String(id));
                if (course) openModal(course);
            }
        }
    });

    /**
     * ===== ÃNCÄ‚RCARE DATE: JSON remote -> fallback la mock extins =====
     * format backend propus:
     * { items: Course[], page: 1, pageSize: 9, total: 123, totalPages: 14 }
     */
    let allCourses = [];

    async function loadCourses() {
        try {
            const res = await fetch(REMOTE_JSON_URL, { cache: 'no-store' });
            if (!res.ok) throw new Error('Nu am gÄƒsit JSON-ul remote');
            const data = await res.json();

            // dacÄƒ backend-ul Ã®È›i dÄƒ deja items/page/pageSize/total, normalizez
            if (Array.isArray(data)) {
                allCourses = data.map(c => ({ ...c, image: imageFor(c) }));
            } else if (Array.isArray(data.items)) {
                allCourses = data.items.map(c => ({ ...c, image: imageFor(c) }));
                // poÈ›i seta È™i state.pageSize = data.pageSize || state.pageSize;
            } else {
                throw new Error('StructurÄƒ JSON neaÈ™teptatÄƒ');
            }
        } catch (e) {
            // fallback: generÄƒm multe cursuri pentru test
            allCourses = expandMock(baseCourses, MAX_AUTOGEN);
        }
    }

    function applyFilters() {
        const st = readState();
        renderChips(st);

        const filtered = allCourses.filter(c => courseMatch(c, st));

        const { total, pageItems } = paginate(filtered, st);
        renderCourses(pageItems);
        renderPager(total, st);

        // right rail
        renderRightRailTop(filtered);
        renderRightRailRecent();
    }

    /**
     * IniÈ›ializare
     */
    renderQuickChips();
    loadCourses().then(applyFilters);
</script>



<!-- Hint: Ã®n Thymeleaf poÈ›i Ã®nlocui mockCourses cu JSON generat din model:
<script th:inline="javascript">
/*<![CDATA[*/
const mockCourses = /*[[${coursesJson}]]*/ [];
/*]]>*/
</script>
-->

</body>

</html>